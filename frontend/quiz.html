<!DOCTYPE html>
<html>
<head>
  <title>Attempt Quiz</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="navbar">
  <div>Online Quiz System</div>
  <div class="nav-links">
    <button onclick="goHome()">Home</button>
    <button onclick="goProfile()">My Profile</button>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<div class="page">
  <div class="container">
    <div class="card">
      <h2 id="sectionTitle"></h2>

      <!-- TIMER -->
      <div id="timer" style="text-align:center; font-weight:bold; color:red;"></div>

      <div id="quiz"></div>
    </div>
  </div>
</div>

<!-- ================= EXIT MODAL ================= -->
<div id="exitModal" class="modal">
  <div class="modal-content">
    <h3>Exit Quiz?</h3>
    <p>Are you sure you want to exit the quiz?</p>

    <div class="modal-buttons">
      <button onclick="confirmExit()" class="danger">OK</button>
      <button onclick="closeExitModal()">Cancel</button>
    </div>
  </div>
</div>

<script>

// ================= SECURITY =================
if(!localStorage.getItem("role") || localStorage.getItem("role") !== "student"){
  window.location.href = "/login.html";
}

let questions = [];
let currentIndex = 0;
let answers = {};
let timeLeft = 300; // ⏱ 5 minutes
let timerInterval;

// ================= GET SECTION =================
const params = new URLSearchParams(window.location.search);
const section = params.get("section");

document.getElementById("sectionTitle").innerText =
  section.toUpperCase() + " Quiz";

// ⭐ Start screen first
showStartScreen();

// ================= START SCREEN =================
function showStartScreen(){
  document.getElementById("quiz").innerHTML = `
    <div style="text-align:center">
      <p>Ready to attempt the <b>${section.toUpperCase()}</b> quiz?</p>
      <button onclick="startQuiz()">Start Quiz</button>
    </div>
  `;
}

// ================= START QUIZ =================
async function startQuiz(){

  const res = await fetch("/api/quiz/section/" + section);
  questions = await res.json();

  if(questions.length === 0){
    document.getElementById("quiz").innerHTML =
      "<p>No questions found for this section</p>";
    return;
  }

  startTimer();
  showQuestion();
}

// ================= TIMER =================
function startTimer(){
  updateTimerDisplay();

  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();

    if(timeLeft <= 0){
      clearInterval(timerInterval);
      alert("Time is up! Quiz auto-submitted.");
      submitQuiz();
    }
  }, 1000);
}

function updateTimerDisplay(){
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;

  document.getElementById("timer").innerText =
    `Time Left: ${minutes}:${seconds.toString().padStart(2,'0')}`;
}

// ================= SHOW QUESTION =================
function showQuestion(){

  const q = questions[currentIndex];

  let html = `
    <div class="question">
      <p><b>Question ${currentIndex + 1} of ${questions.length}</b></p>
      <p><b>${q.question}</b></p>
  `;

  q.options.forEach(opt => {
    const checked = answers[q._id] === opt ? "checked" : "";

    html += `
      <input type="radio" name="q" value="${opt}"
      ${checked}
      onchange="saveAnswer('${q._id}','${opt}')"> ${opt} <br>
    `;
  });

  html += `<br>`;

  if(currentIndex > 0){
    html += `<button onclick="prevQuestion()">Previous</button>`;
  }

  if(currentIndex < questions.length - 1){
    html += `<button onclick="nextQuestion()">Next</button>`;
  }

  html += `<button onclick="submitQuiz()">Submit Quiz</button>`;
  html += `<button onclick="exitQuiz()" style="background:#e74a3b;">Exit Quiz</button>`;

  html += `</div>`;

  document.getElementById("quiz").innerHTML = html;
}

// ================= SAVE =================
function saveAnswer(id,val){
  answers[id] = val;
}

// ================= NEXT =================
function nextQuestion(){
  currentIndex++;
  showQuestion();
}

// ================= PREVIOUS =================
function prevQuestion(){
  currentIndex--;
  showQuestion();
}

// ================= SUBMIT =================
async function submitQuiz(){

  clearInterval(timerInterval);

  const res = await fetch("/api/submit-quiz",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      section: section,
      answers: answers,
      userEmail: localStorage.getItem("email")
    })
  });

  const data = await res.json();

  alert("Your Score: " + data.score + "/" + data.total);
  window.location.href = "profile.html";
}

// ================= EXIT MODAL =================
function exitQuiz(){
  document.getElementById("exitModal").style.display = "flex";
}

function closeExitModal(){
  document.getElementById("exitModal").style.display = "none";
}

function confirmExit(){
  clearInterval(timerInterval);
  window.location.href = "/";
}

// ================= NAV =================
function goHome(){
  window.location.href = "/";
}

function goProfile(){
  window.location.href = "profile.html";
}

function logout(){
  localStorage.removeItem("role");
  localStorage.removeItem("email");
  window.location.href = "/login.html";
}

</script>

</body>
</html>
